{% extends 'base_new.html' %}

{% block title %}
{%- if view == 'recents' -%}Chats - MV Internal
{%- elif view == 'conversation' -%}Chat - MV Internal
{%- else -%}Chat - MV Internal
{%- endif -%}
{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
<style>
/* Chat-specific styles that aren't shared */
.welcome-screen {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    flex: 1;
    padding: 2rem;
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
}

.welcome-greeting {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 2rem;
}

.welcome-greeting-main {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.welcome-icon {
    width: 32px;
    height: 32px;
    color: var(--color-accent);
}

.welcome-text {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--color-text);
}

.welcome-project-badge {
    display: none;
    align-items: center;
    gap: 0.5rem;
    background: var(--color-bg-secondary);
    padding: 0.5rem 0.75rem;
    border-radius: 20px;
    border: 1px solid var(--color-border);
    font-size: 0.875rem;
}

.welcome-project-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--color-accent);
}

.welcome-input-container {
    width: 100%;
    max-width: 500px;
    margin-bottom: 2rem;
}

.welcome-input {
    width: 100%;
    min-height: 60px;
    padding: 1rem;
    border: 2px solid var(--color-border);
    border-radius: 12px;
    font-size: 1rem;
    font-family: inherit;
    resize: none;
    outline: none;
    transition: border-color 0.15s;
}

.welcome-input:focus {
    border-color: var(--color-accent);
}

.welcome-input-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.5rem;
    padding: 0 0.5rem;
}

.welcome-input-actions {
    display: flex;
    gap: 0.5rem;
}

.welcome-action-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: transparent;
    color: var(--color-text-secondary);
    cursor: pointer;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
}

.welcome-action-btn:hover {
    background: var(--color-hover);
    color: var(--color-text);
}

.welcome-model-select {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.welcome-model-select select {
    padding: 0.5rem;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    font-size: 0.875rem;
    background: white;
}

.welcome-send-btn {
    width: 40px;
    height: 40px;
    background: var(--color-accent);
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
}

.welcome-send-btn:hover {
    background: #c46a4a;
}

.welcome-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: center;
}

.welcome-chip {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: white;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    font-size: 0.875rem;
    color: var(--color-text);
    cursor: pointer;
    transition: all 0.15s;
}

.welcome-chip:hover {
    background: var(--color-hover);
    border-color: var(--color-accent);
}

.welcome-chip svg {
    width: 16px;
    height: 16px;
}

/* Chat messages area */
.chat-messages {
    flex: 1;
    padding: 1.5rem;
    padding-bottom: 140px;
    max-width: 768px;
    width: 100%;
    margin: 0 auto;
    box-sizing: border-box;
}

/* Input area */
.input-area {
    position: fixed;
    bottom: 0;
    left: 280px;
    right: 0;
    background: var(--color-bg);
    border-top: 1px solid var(--color-border);
    padding: 1rem;
    z-index: 10;
}

.input-wrap {
    max-width: 768px;
    margin: 0 auto;
}

.model-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    font-size: 0.875rem;
    color: var(--color-text-secondary);
}

.model-select {
    padding: 0.375rem 0.5rem;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    font-size: 0.8125rem;
    background: white;
}

.input-box {
    display: flex;
    align-items: end;
    gap: 0.75rem;
    background: white;
    border: 2px solid var(--color-border);
    border-radius: 12px;
    padding: 0.75rem;
    transition: border-color 0.15s;
}

.input-box:focus-within {
    border-color: var(--color-accent);
}

.chat-input {
    flex: 1;
    border: none;
    outline: none;
    font-size: 0.9375rem;
    font-family: inherit;
    resize: none;
    min-height: 24px;
    max-height: 120px;
}

.send-btn {
    width: 36px;
    height: 36px;
    background: var(--color-accent);
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.15s;
}

.send-btn:hover {
    background: #c46a4a;
}

/* Chat list styles now in components.css - removed to avoid conflicts */

/* Modal styles */
.video-modal, .share-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.video-container, .share-modal-content {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    max-width: 90vw;
    max-height: 90vh;
    overflow: auto;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .input-area {
        left: 0;
    }

    .welcome-chips {
        flex-direction: column;
        align-items: center;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Chat header bar with project breadcrumb, title dropdown, and share -->
<div class="chat-header-bar" id="chatHeaderBar">
    <div class="chat-header-left">
        <!-- Project link (shown when chat is in a project) -->
        <a href="#" class="chat-project-link" id="chatProjectLink" style="display: none;" onclick="goToProject(event)">
            <span class="project-dot" id="chatProjectDot"></span>
            <span id="chatProjectName">Project</span>
        </a>
        <span class="chat-breadcrumb-separator" id="chatBreadcrumb" style="display: none;">/</span>
        <!-- Chat title with dropdown -->
        <button class="chat-title-dropdown" id="chatTitleDropdown" onclick="openChatMenu(event, currentConversationId, document.getElementById('chatTitleText')?.textContent || 'Chat', true)">
            <span class="chat-title-text" id="chatTitleText">Chat</span>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        </button>
    </div>
    <button class="share-btn" onclick="shareChat()">Share</button>
</div>

<!-- Chats List View - shown only on /chat/recents route -->
{% if view == 'recents' %}
<div class="chats-list-view active" id="chatsListView">
    <div class="chats-list-header">
        <h1 class="chats-list-title">Chats</h1>
        <button class="btn" onclick="createNewConversationFromList()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
            New chat
        </button>
    </div>
    <div class="chats-search-wrapper">
        <input type="text" class="chats-search" id="chatsSearch" placeholder="Search your chats..." oninput="filterChatsList()">
    </div>
    <div class="chats-count-row">
        <span id="chatsCount">0 chats with MV Internal</span>
        <button class="chats-select-btn" onclick="toggleSelectMode()">Select</button>
    </div>
    <div class="chats-select-actions">
        <span class="select-count" id="selectCount">0 selected</span>
        <button class="select-action-btn" onclick="toggleSelectMode()">Cancel</button>
        <button class="select-action-btn danger" onclick="deleteSelectedChats()">Delete</button>
    </div>
    <div class="chats-list" id="chatsList">
        <!-- Chat items loaded dynamically -->
    </div>
</div>
{% endif %}

<!-- New Claude.ai-style chat interface - shown for both new chat and conversation views -->
{% if view == 'new' or view == 'conversation' %}
<div class="chat-page{% if view == 'conversation' %} has-messages{% endif %}">
    <!-- Welcome Section (shown when no messages) -->
    <div class="chat-welcome" id="chatWelcome">
        <div class="welcome-content">
            <div class="welcome-icon">
                <!-- Orange asterisk SVG -->
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                    <path d="M16 2L18.5 13.5L30 16L18.5 18.5L16 30L13.5 18.5L2 16L13.5 13.5L16 2Z" fill="#d97757"/>
                </svg>
            </div>
            <h1 class="welcome-greeting" id="welcomeGreeting">Good afternoon, {{ user.name or 'Joy' }}</h1>
        </div>
    </div>

    <!-- Messages Container (hidden initially) -->
    <div class="chat-messages" id="chatMessages"></div>

    <!-- Input Section (always visible, at bottom) -->
    <div class="chat-input-section">
        <div class="chat-input-wrapper">
            <div class="chat-input-box" id="chatInputBox">
                <textarea
                    id="chatInput"
                    class="chat-textarea"
                    placeholder="How can I help you today?"
                    rows="1"
                ></textarea>

                <div class="chat-input-controls">
                    <div class="controls-left">
                        <button type="button" id="attachBtn" class="control-btn" title="Add content">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>
                        <button type="button" id="historyBtn" class="control-btn" title="Recent">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                        </button>
                    </div>

                    <div class="controls-right">
                        <div class="model-selector" id="modelSelector">
                            <button type="button" class="model-selector-btn" id="modelSelectorBtn">
                                <span class="model-name">Sonnet 4</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>

                            <!-- Model Dropdown -->
                            <div class="model-dropdown" id="modelDropdown">
                                <button type="button" class="model-option" data-model="opus-4.5">
                                    <div class="model-info">
                                        <span class="model-option-name">Opus 4.5</span>
                                        <span class="model-option-desc">Most capable for complex work</span>
                                    </div>
                                    <span class="model-check">‚úì</span>
                                </button>
                                <button type="button" class="model-option selected" data-model="sonnet-4">
                                    <div class="model-info">
                                        <span class="model-option-name">Sonnet 4</span>
                                        <span class="model-option-desc">Best for everyday tasks</span>
                                    </div>
                                    <span class="model-check">‚úì</span>
                                </button>
                                <button type="button" class="model-option" data-model="haiku-4.5">
                                    <div class="model-info">
                                        <span class="model-option-name">Haiku 4.5</span>
                                        <span class="model-option-desc">Fastest for quick answers</span>
                                    </div>
                                    <span class="model-check">‚úì</span>
                                </button>
                                <div class="dropdown-divider"></div>
                                <button type="button" class="model-option more-models">
                                    <span>More models</span>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <button type="button" id="sendBtn" class="send-btn" disabled>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <line x1="12" y1="19" x2="12" y2="5"></line>
                                <polyline points="5 12 12 5 19 12"></polyline>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Attachment Menu Dropdown -->
            <div class="attach-dropdown" id="attachDropdown">
                <button type="button" class="attach-option" data-action="add-files">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                    </svg>
                    <span>Add files or photos</span>
                </button>
                <button type="button" class="attach-option" data-action="screenshot">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    <span>Take a screenshot</span>
                </button>
                <button type="button" class="attach-option has-submenu" data-action="add-to-project">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span>Add to project</span>
                    <svg class="submenu-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
                <div class="dropdown-divider"></div>
                <button type="button" class="attach-option" data-action="research">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <span>Research</span>
                </button>
                <button type="button" class="attach-option" data-action="web-search">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    <span>Web search</span>
                    <span class="option-check">‚úì</span>
                </button>
                <button type="button" class="attach-option has-submenu" data-action="use-style">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                        <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                    </svg>
                    <span>Use style</span>
                    <svg class="submenu-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Quick Action Chips -->
        <div class="quick-actions" id="quickActions">
            <button type="button" class="quick-action-chip" data-action="write">
                <span class="chip-icon">‚úèÔ∏è</span>
                <span>Write</span>
            </button>
            <button type="button" class="quick-action-chip" data-action="learn">
                <span class="chip-icon">üìö</span>
                <span>Learn</span>
            </button>
            <button type="button" class="quick-action-chip" data-action="code">
                <span class="chip-icon">&lt;/&gt;</span>
                <span>Code</span>
            </button>
            <button type="button" class="quick-action-chip" data-action="life-stuff">
                <span class="chip-icon">üéØ</span>
                <span>Life stuff</span>
            </button>
            <button type="button" class="quick-action-chip" data-action="claude-choice">
                <span class="chip-icon">‚ú®</span>
                <span>Claude's choice</span>
            </button>
        </div>
    </div>
</div>
{% endif %}


<!-- Video Preview Modal -->
<div class="video-modal" id="videoModal" onclick="closeModal(event)">
    <div class="video-container" onclick="event.stopPropagation()">
        <button class="close-modal" onclick="closePreview()">&times;</button>
        <div class="video-header">
            <span class="video-title" id="previewTitle">Video Preview</span>
            <span class="video-time" id="previewTime"></span>
        </div>
        <video id="previewVideo" controls></video>
    </div>
</div>

<!-- Share Modal -->
<div class="share-modal" id="shareModal" onclick="closeShareModal(event)">
    <div class="share-modal-content" onclick="event.stopPropagation()">
        <h3>
            Share Conversation
            <button class="close-btn" onclick="closeShareModal()">&times;</button>
        </h3>
        <input type="text" class="user-search" id="userSearch" placeholder="Search team members by name or email..." oninput="searchUsers(this.value)">
        <div class="search-results" id="searchResults"></div>
        <div class="participants-list" id="participantsList">
            <h4>Participants</h4>
            <div id="participantsContent">Loading...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Route-based view (set by server)
const CURRENT_VIEW = '{{ view }}';
const CONVERSATION_ID = '{{ conversation_id or "" }}';
const PROJECT_ID = '{{ project_id or "" }}';

const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const conversationsList = document.getElementById('conversationsList');

let history = [];
let clips = [];
let audioClips = [];
let currentAudioPlayer = null;
let lastQuery = '';
let lastScript = '';
let lastModel = '';
let currentConversationId = CONVERSATION_ID || null;
let currentProjectId = null;
let currentProject = null;  // Full project info {id, name, color}
let conversations = {% if conversations is defined %}{{ conversations | tojson | safe }}{% else %}[]{% endif %};

// Select mode state (for list views)
let isSelectMode = false;
let selectedChats = new Set();

// Chat menu state - explicitly on window for guaranteed global access
window.menuChatId = null;
window.menuChatTitle = null;

// Initialize based on route
document.addEventListener('DOMContentLoaded', async () => {
    // Sidebar data is now server-rendered by Jinja - no initial JS load needed

    // Initialize based on current route/view
    if (CURRENT_VIEW === 'recents') {
        // Chats list view - render list
        renderChatsList();
    } else if (CURRENT_VIEW === 'conversation' && CONVERSATION_ID) {
        // Conversation view - load the specific conversation
        await loadConversationData(CONVERSATION_ID);

        // Check for pending message from welcome screen
        const pendingMessage = sessionStorage.getItem('pendingMessage');
        const pendingModel = sessionStorage.getItem('pendingModel');
        if (pendingMessage) {
            sessionStorage.removeItem('pendingMessage');
            sessionStorage.removeItem('pendingModel');

            // Set the model if specified
            if (pendingModel) {
                const modelSelect = document.getElementById('modelSelect');
                if (modelSelect) {
                    modelSelect.value = pendingModel;
                }
            }

            // Auto-send the message
            chatInput.value = pendingMessage;
            setTimeout(() => sendMessage(), 100);
        }
    } else if (CURRENT_VIEW === 'new') {
        // New chat view - set up welcome screen with project context
        setupWelcomeScreen();
    }

    // Initialize project context if specified in URL
    if (PROJECT_ID) {
        await setupProjectContext(PROJECT_ID);
    }
});

// CRITICAL CHAT LIST FUNCTIONS
function renderChatsList() {
    const chatsList = document.getElementById('chatsList');
    const chatsSearch = document.getElementById('chatsSearch');
    const chatsCount = document.getElementById('chatsCount');

    // Only render if elements exist (recents view)
    if (!chatsList) return;

    const searchTerm = chatsSearch ? chatsSearch.value.toLowerCase() : '';

    // Filter out empty chats (message_count === 0) and apply search
    const filteredChats = conversations.filter(conv =>
        conv.message_count > 0 && conv.title.toLowerCase().includes(searchTerm)
    );

    if (chatsCount) {
        chatsCount.textContent = `${filteredChats.length} chat${filteredChats.length !== 1 ? 's' : ''} with MV Internal`;
    }

    chatsList.innerHTML = filteredChats.map(conv => `
        <div class="chat-list-item" data-id="${conv.id}" onclick="openChatFromList('${conv.id}')">
            <input type="checkbox" class="chat-list-checkbox"
                   ${selectedChats.has(conv.id) ? 'checked' : ''}
                   onclick="event.stopPropagation(); toggleChatSelection('${conv.id}')">
            <div class="chat-list-content">
                <div class="chat-list-title">
                    ${conv.starred ? '<span class="chat-star-icon">‚òÖ</span>' : ''}${escapeHtml(conv.title)}
                </div>
                <div class="chat-list-meta">Last message ${timeAgo(conv.updated_at)}</div>
            </div>
            <div class="chat-list-actions">
                <button class="chat-list-action-btn" onclick="event.stopPropagation(); openChatMenu(event, '${conv.id}', '${escapeHtml(conv.title)}')" title="Options">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/>
                    </svg>
                </button>
            </div>
        </div>
    `).join('');
}

function filterChatsList() {
    renderChatsList();
}

function openChatFromList(chatId) {
    window.location.href = `/chat/${chatId}`;
}

function createNewConversationFromList() {
    window.location.href = '/chat';
}

function timeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);

    const intervals = [
        { label: 'year', seconds: 31536000 },
        { label: 'month', seconds: 2592000 },
        { label: 'week', seconds: 604800 },
        { label: 'day', seconds: 86400 },
        { label: 'hour', seconds: 3600 },
        { label: 'minute', seconds: 60 }
    ];

    for (const interval of intervals) {
        const count = Math.floor(seconds / interval.seconds);
        if (count >= 1) {
            return `${count} ${interval.label}${count !== 1 ? 's' : ''} ago`;
        }
    }
    return 'just now';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function toggleSelectMode() {
    isSelectMode = !isSelectMode;
    const chatsListView = document.getElementById('chatsListView');
    if (chatsListView) {
        chatsListView.classList.toggle('select-mode', isSelectMode);
    }
    selectedChats.clear();
    updateSelectCount();
}

function toggleChatSelection(chatId) {
    if (selectedChats.has(chatId)) {
        selectedChats.delete(chatId);
    } else {
        selectedChats.add(chatId);
    }
    updateSelectCount();
}

function updateSelectCount() {
    const selectCount = document.getElementById('selectCount');
    if (selectCount) {
        selectCount.textContent = `${selectedChats.size} selected`;
    }
}

function deleteSelectedChats() {
    if (selectedChats.size === 0) return;

    if (confirm(`Are you sure you want to delete ${selectedChats.size} chat${selectedChats.size !== 1 ? 's' : ''}?`)) {
        // Implementation for bulk delete would go here
        console.log('Deleting chats:', Array.from(selectedChats));
    }
}

// ==========================================
// CHAT MENU FUNCTIONS
// ==========================================

function openChatMenu(event, chatId, chatTitle, fromHeader = false) {
    event.preventDefault();
    event.stopPropagation();

    const menu = document.getElementById('chatMenu');
    if (!menu) return;

    // Toggle off if same chat
    if (menu.classList.contains('open') && window.menuChatId === chatId) {
        closeChatMenu();
        return;
    }

    window.menuChatId = chatId;
    window.menuChatTitle = chatTitle;

    // Update star button based on current state
    const conv = (typeof conversations !== 'undefined' && conversations) ?
        conversations.find(c => c.id === chatId) : null;
    const isStarred = conv ? conv.starred : false;
    const starIcon = document.getElementById('starIcon');
    const starText = document.getElementById('starText');
    if (starIcon && starText) {
        starIcon.textContent = isStarred ? '‚òÖ' : '‚òÜ';
        starText.textContent = isStarred ? 'Unstar' : 'Star';
    }

    // Position the menu
    const rect = event.currentTarget.getBoundingClientRect();

    if (fromHeader) {
        // Below the title button
        menu.style.top = (rect.bottom + 6) + 'px';
        menu.style.left = rect.left + 'px';
    } else {
        // Next to the ‚Ä¢‚Ä¢‚Ä¢ button in chat list
        menu.style.top = rect.top + 'px';
        menu.style.left = (rect.right + 6) + 'px';
    }

    menu.classList.add('open');

    // Adjust if off-screen
    setTimeout(() => {
        const menuRect = menu.getBoundingClientRect();
        if (menuRect.right > window.innerWidth) {
            menu.style.left = (rect.left - menuRect.width - 6) + 'px';
        }
        if (menuRect.bottom > window.innerHeight) {
            menu.style.top = (window.innerHeight - menuRect.height - 10) + 'px';
        }
    }, 0);
}

function closeChatMenu() {
    const menu = document.getElementById('chatMenu');
    if (menu) menu.classList.remove('open');
    window.menuChatId = null;
    window.menuChatTitle = null;
}

function chatMenuAction(action) {
    if (!window.menuChatId) return;

    switch (action) {
        case 'star':
            // Find the conversation to get current starred state
            const conv = (typeof conversations !== 'undefined' && conversations) ?
                conversations.find(c => c.id === window.menuChatId) : null;
            const currentStarred = conv ? conv.starred : false;
            const newStarred = !currentStarred;

            fetch(`/api/conversations/${window.menuChatId}/star`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ starred: newStarred })
            })
            .then(r => {
                if (r.ok) {
                    // Update the conversation in the array if it exists
                    if (conv) {
                        conv.starred = newStarred;
                    }

                    // Re-render the list only if we're on the recents page
                    if (typeof renderChatsList === 'function') {
                        renderChatsList();
                    }

                    showToast(newStarred ? 'Chat starred' : 'Chat unstarred', 'success');
                } else {
                    showToast('Failed to update star', 'error');
                }
            })
            .catch(() => showToast('Failed to update star', 'error'));
            break;

        case 'rename':
            const newName = prompt('Enter new name:', window.menuChatTitle);
            if (newName && newName.trim() && newName !== window.menuChatTitle) {
                fetch(`/api/conversations/${window.menuChatId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: newName.trim() })
                })
                .then(r => {
                    if (r.ok) {
                        // Update the chat list item
                        const listItem = document.querySelector(`[data-id="${window.menuChatId}"]`);
                        if (listItem) {
                            const titleEl = listItem.querySelector('.chat-list-title');
                            if (titleEl) titleEl.textContent = newName.trim();
                        }

                        // Update conversations array if it exists
                        if (typeof conversations !== 'undefined' && conversations) {
                            const conv = conversations.find(c => c.id === window.menuChatId);
                            if (conv) {
                                conv.title = newName.trim();
                            }
                        }

                        // Re-render the list only if we're on the recents page
                        if (typeof renderChatsList === 'function') {
                            renderChatsList();
                        }

                        showToast('Chat renamed', 'success');
                    } else {
                        showToast('Failed to rename', 'error');
                    }
                })
                .catch(() => showToast('Failed to rename', 'error'));
            }
            break;

        case 'addToProject':
            showToast('Project picker coming soon', 'info');
            break;

        case 'delete':
            if (confirm(`Delete "${window.menuChatTitle}"?`)) {
                fetch(`/api/conversations/${window.menuChatId}`, { method: 'DELETE' })
                .then(r => {
                    if (r.ok) {
                        // Remove from conversations array if it exists
                        if (typeof conversations !== 'undefined' && conversations) {
                            conversations = conversations.filter(c => c.id !== window.menuChatId);
                        }

                        // Re-render the chat list only if we're on the recents page
                        if (typeof renderChatsList === 'function') {
                            renderChatsList();
                        }

                        showToast('Chat deleted', 'success');
                    } else {
                        showToast('Failed to delete', 'error');
                    }
                })
                .catch(() => showToast('Failed to delete', 'error'));
            }
            break;
    }

    closeChatMenu();
}

// Close menu when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('#chatMenu') && !e.target.closest('.chat-list-action-btn')) {
        closeChatMenu();
    }
});

// showToast() function available via shared.js
</script>
{% endblock %}